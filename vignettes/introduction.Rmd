---
title: "Introduction to parlitools"
author: "Evan Odell"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to parlitools}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Creating a hexagonal map of constituencies

Create a hexagonal map of all constituency MPs, at the time Parliament was dissolved for the 2017 General Election.

Note, this uses packages that are not imported by `parlitools`, namely `leaflet`, `htmltools` and `sf`. It also requires a version of `mnis` > v0.2.3. You may have to install the development version of `mnis`:

```
#install.packages("devtools")
devtools::install_github("evanodell/mnis")
```

Use the code below to create the hexagonal map of current (as of 19 April 2017) UK constituency MPs.

```{r fig.width= 8, fig.height=4,message=FALSE}
  library(leaflet)
  library(sf)
  library(dplyr)
  library(hansard)
  devtools::install_github("evanodell/mnis") # If installed version of `mnis` is v0.2.3 or less
  library(mnis)
  
  west_hex_map <- parlitools::west_hex_map
  
  constit <- constituencies() #Get list of current consituencies
  
  current <- mnis_eligible(house="commons") #Get list of current MPs
  
  current_mps <- left_join(current, constit, by = c("member_from"= "label_value")) ## Join together
  
  party_colour <- parlitools::party_colour ## Party colour data
  
  current_mps_colours <- left_join(current_mps, party_colour, by = "party_id") ## Join to current MP data
  
  west_hex_map2 <- left_join(west_hex_map, current_mps_colours, by = "gss_code") ## Join to hexagon map
  
  elect2015 <- election_results(382386) # Get 2015 General Election Results
  
  west_hex_map2 <- left_join(west_hex_map2, elect2015, by = c("about"= "constituency_about")) ## Join together

  # Creating map labels
  labels <- paste0(
   "<strong>", west_hex_map2$member_from, "</strong>", "</br>",
    west_hex_map2$party_name, "</br>",
    west_hex_map2$display_as, "</br>",
    "2015 Result: ", west_hex_map2$result_of_election, "</br>",
    "2015 Majority: ", west_hex_map2$majority
  ) %>% lapply(htmltools::HTML)
  
  # Creating the map itself
  leaflet(
    west_hex_map2) %>%
    addPolygons(
      color = "grey",
      weight=0.75,
      opacity = 0.5,
      fillOpacity = 1,
      fillColor = ~party_colour,
      label=labels) 
```



## Mapping Parliamentary Petitions

The [UK Parliamentary Petition site](https://petition.parliament.uk/) has facilities for mapping which parliamentary constituencies signatories of petitions live in. However, it only produces geographic maps, not hexagrams.

I have chosen two competing petitions: 'Donald Trump should make a State Visit to the United Kingdom' and 'Prevent Donald Trump from making a State Visit to the United Kingdom', both of which attracted large numbers of signatures: 317,492 for the pro-Trump petition, and 1,863,565 on the anti-Trump petition. The  two maps use different colour scales, as using the same colour scale for both maps, which can aid direct comparison, renders the pro-Trump map too faint to read.

### Pro-Trump petition signatories

```{r fig.width= 8, fig.height=4,message=FALSE}
library(leaflet)
library(sf)
library(dplyr)
library(hansard)

west_hex_map <- parlitools::west_hex_map #Base map

trump_yes <- epetition(ID = 680905, by_constituency=TRUE) #Download pro-inviting Trump signatures

pal = colorNumeric("Oranges", trump_yes$number_of_signatures)

west_trump_yes <- left_join(west_hex_map, trump_yes, by = "gss_code") #Joining to base map

label_yes <- paste0(
  "<strong>", west_trump_yes$constituency_name, "</strong>", "</br>",
  "Signatures: ", west_trump_yes$number_of_signatures
) %>% lapply(htmltools::HTML)

leaflet(
  west_trump_yes) %>%
  addPolygons(
    color = "grey",
    weight=0.75,
    opacity = 0.5,
    fillOpacity = 1,
    fillColor = ~pal(number_of_signatures),
    label = label_yes) %>%
  addLegend("topright", pal = pal, values = ~number_of_signatures,
    title = "Number of Signatures",
    opacity = 1
  )
```


### Anti-Trump petition signatories

```{r fig.width= 8, fig.height=4,message=FALSE}
library(leaflet)
library(sf)
library(dplyr)
library(hansard)

west_hex_map <- parlitools::west_hex_map #Base map

trump_no <- epetition(ID = 648278, by_constituency=TRUE) #Download anti-inviting Trump signatures

west_trump_no <- left_join(west_hex_map, trump_no, by = "gss_code") #Joining to base map

pal = colorNumeric("Blues", trump_no$number_of_signatures)

label_no <- paste0(
  "<strong>", west_trump_no$constituency_name, "</strong>", "</br>",
  "Signatures: ", west_trump_no$number_of_signatures
) %>% lapply(htmltools::HTML)

leaflet(
  west_trump_no) %>%
  addPolygons(
    color = "grey",
    weight=0.75,
    opacity = 0.5,
    fillOpacity = 1,
    fillColor = ~pal(number_of_signatures),
    label = label_no) %>%
  addLegend("topright", pal = pal, values = ~number_of_signatures,
    title = "Number of Signatures",
    opacity = 1
  )
```



