---
title: "Using cartograms with parlitools"
author: "Evan Odell"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Usiing cartograms with parlitools}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Scaling with `cartogram`

You can use the [`cartogram`](https://CRAN.R-project.org/package=cartogram) package with `parlitools` to produce maps with scaled areas, as seen in [Xinye Li's post on Brexit votes](https://xinye1.github.io/projects/brexit-cartogram-leaflet/). 

As the cartogram package requires SpatialPolygonsDataFrame objects, instead of simple features objects, the `west_hex_map` object is converted first to a Spatial object, and then to a SpatialPolygonsDataFrame object, as there is no function to convert directly from sf to SpatialPolygonsDataFrame.

## Scaling by marginality

This map scales constituencies based on how marginal they are, by subtracting the majority (the difference in votes between the winning and second place candidate) from 100 and cubing that value. Larger constituencies are those deemed to be more marginal.

It uses datasets included in this package, namely the British Election Study (`bes_2015`), `party_colours` and `west_hex_map`. As the BES only covers Wales, Scotland and England, Northern Ireland is not included in the map.

```{r fig.width=6, fig.height=7, message=FALSE, warning=FALSE}

gb_hex_map$marginality <- (100-gb_hex_map$majority_15)^3

gp_hex_scaled <- cartogram(gb_hex_map, 'marginality')

# Creating map labels
labels <- paste0(
  "Constituency: ", gp_hex_scaled$constituency_name.y, "</br>",
  "Most Recent Winner: ", gp_hex_scaled$winner_15, "</br>",
  "Most Recent Majority: ", gp_hex_scaled$majority_15, "%","</br>",
  "Turnout: ", gp_hex_scaled$turnout_15, "%"
) %>% lapply(htmltools::HTML)

# Creating the map itself
leaflet(options=leafletOptions(
  dragging = FALSE, zoomControl = FALSE, tap = FALSE,
  minZoom = 6, maxZoom = 6, maxBounds = list(list(2.5,-7.75),list(58.25,50.0)),
  attributionControl = FALSE),
  gp_hex_scaled) %>%
  addPolygons(
    color = "grey",
    weight=0.75,
    opacity = 0.5,
    fillOpacity = 1,
    fillColor = ~party_colour,
    label=labels) %>% 
  htmlwidgets::onRender(
    "function(x, y) {
        var myMap = this;
        myMap._container.style['background'] = '#fff';
    }")%>% 
  mapOptions(zoomToLimits = "first")

```

